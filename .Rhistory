getwd()
### LAS INSTALACIONES REALIZARLAS EN UN SCRIP APARTE
### CON EL FIN DE NO GENERAR PROBLEMAS EN EL RENDER DEL qmd.
# install.packages("here")
# install.packages("sf")
# install.packages("terra")
# install.packages("geodata")
# install.packages("tmap")
# install.packages("leaflet")
# c("sf", "tmap", "leaflet", "geodata", "terra", "tmap") %in% installed.packages()
library(here)
library(sf)
library(terra)
library(geodata)
library(tmap)
library(leaflet)
# Crear carpeta data si no existe
dir.create(here("data"), showWarnings = FALSE)
# Descargar Perú nivel 1 (departamentos) y guardar en /data
peru_lvl1 <- geodata::gadm("PER", level = 1, path = here("data"))
# Convertir a sf
deps <- sf::st_as_sf(peru_lvl1)
# Mostrar objeto
deps
tmap_mode("plot")
tm_shape(deps) +
tm_polygons() +
tm_layout(title = "Mapa del Perú – Departamentos")
tm_shape(deps) +
tm_polygons("NAME_1", palette = "Set3", title = "Departamento") +
tm_text("NAME_1", size = 0.5) +
tm_layout(title = "Departamentos del Perú con etiquetas")
# Asegura CRS WGS84 para web
deps_wgs <- sf::st_transform(deps, 4326)
pal <- colorNumeric("viridis", domain = deps_wgs$montoviable)
leaflet(deps_wgs) |>
addProviderTiles("CartoDB.Positron") |>
addPolygons(
fillColor = ~pal(montoviable),
color = "#444444", weight = 1, opacity = 1,
fillOpacity = 0.7,
label = ~NAME_1,
popup = ~paste0(
"<b>Departamento:</b> ", NAME_1, "<br>",
"<b>Monto viable (M):</b> ", round(montoviable, 1)
)
) |>
addLegend("bottomright", pal = pal, values = ~montoviable,
title = "Monto viable (M)")
# Crear carpeta data si no existe
dir.create(here("data"), showWarnings = FALSE)
# Descargar Perú nivel 1 (departamentos) y guardar en /data
peru_lvl1 <- geodata::gadm("PER", level = 1, path = here("data"))
# Convertir a sf
deps <- sf::st_as_sf(peru_lvl1)
# Mostrar objeto
deps
tmap_mode("plot")
tm_shape(deps) +
tm_polygons() +
tm_layout(title = "Mapa del Perú – Departamentos")
tm_shape(deps) +
tm_polygons("NAME_1", palette = "Set3", title = "Departamento") +
tm_text("NAME_1", size = 0.5) +
tm_layout(title = "Departamentos del Perú con etiquetas")
tmap_mode("view")
tm_shape(deps) + tm_polygons("NAME_1")
leaflet(deps) |>
addProviderTiles("CartoDB.Positron") |>
addPolygons()
tmap_mode("plot")
# Mapa base
tm_shape(deps) +
tm_polygons() +
tm_scale_bar() +
tm_compass(type = "8star") +
tm_layout(title = "Perú – Departamentos",
legend.outside = TRUE)
tm_shape(deps) +
tm_polygons(col = "NAME_1", palette = "Set3", title = "Departamento") +
tm_text("NAME_1", size = 0.5, col = "black") +
tm_scale_bar() + tm_compass() +
tm_layout(title = "Perú – con etiquetas", legend.outside = TRUE)
tmap_save(
tm_shape(deps) + tm_polygons() + tm_layout(title = "Perú – PNG"),
filename = here::here("mapas_guia_files", "peru_departamentos.png"),
width = 2000, height = 1400, dpi = 200
)
set.seed(1)
deps$montoviable <- runif(nrow(deps), 10, 100)  # ejemplo
tm_shape(deps) +
tm_polygons("montoviable", palette = "viridis", style = "quantile",
title = "Monto viable (M)") +
tm_layout(title = "Choropleth – ejemplo")
tmap_mode("view")
tm_shape(deps) +
tm_polygons("montoviable",
id = "NAME_1",                      # aparece en tooltip
popup.vars = c(Departamento = "NAME_1",
"Monto viable (M)" = "montoviable")) +
tm_basemap("CartoDB.Positron")
tmap_mode("view")
mapa_inter <- tm_shape(deps) +
tm_polygons("montoviable",
id = "NAME_1",
popup.vars = c("Departamento" = "NAME_1",
"Monto viable (M)" = "montoviable")) +
tm_basemap("CartoDB.Positron")
tmap_save(mapa_inter,
filename = here::here("mapas_guia_files", "peru_departamentos.html"))
# Asegura CRS WGS84 para web
deps_wgs <- sf::st_transform(deps, 4326)
pal <- colorNumeric("viridis", domain = deps_wgs$montoviable)
leaflet(deps_wgs) |>
addProviderTiles("CartoDB.Positron") |>
addPolygons(
fillColor = ~pal(montoviable),
color = "#444444", weight = 1, opacity = 1,
fillOpacity = 0.7,
label = ~NAME_1,
popup = ~paste0(
"<b>Departamento:</b> ", NAME_1, "<br>",
"<b>Monto viable (M):</b> ", round(montoviable, 1)
)
) |>
addLegend("bottomright", pal = pal, values = ~montoviable,
title = "Monto viable (M)")
deps_utm <- sf::st_transform(deps, 32718)  # UTM 18S
deps_utm$area_km2 <- as.numeric(sf::st_area(deps_utm)) / 1e6
# Mapa estático con áreas
tmap_mode("plot")
tm_shape(deps_utm) +
tm_polygons("area_km2", palette = "plasma", style = "quantile",
title = "Área (km²)") +
tm_layout(title = "Perú – Área por departamento")
# Para web: volver a WGS84
deps_web <- sf::st_transform(deps_utm, 4326)
#| label: mapa-interactivo
#| results: asis
library(sf)
library(leaflet)
# Cargar geometría ya guardada solo si existe, sino descargar 1 sola vez
gpkg <- here::here("data/peru_deps_lvl1.gpkg")
if (!file.exists(gpkg)) {
peru_lvl1 <- geodata::gadm("PER", level = 1, path = here("data"))
deps <- sf::st_as_sf(peru_lvl1)
sf::st_write(deps, gpkg, delete_dsn = TRUE)
}
deps <- sf::st_read(gpkg, quiet = TRUE)
deps_view <- sf::st_simplify(deps, dTolerance = 0.03, preserveTopology = TRUE)
deps_wgs <- sf::st_transform(deps_view, 4326)
# Dato de práctica si no existe
if (!"montoviable" %in% names(deps_wgs)) {
set.seed(1)
deps_wgs$montoviable <- runif(nrow(deps_wgs), 10, 100)
}
# Crear paleta automática (sin definir colores manuales)
pal <- colorNumeric(palette = NULL, domain = deps_wgs$montoviable)
#| label: mapa-interactivo
#| echo: false
#| warning: false
#| message: false
library(here)
library(sf)
library(geodata)
library(leaflet)
dir.create(here("data"), showWarnings = FALSE)
gpkg <- here("data", "peru_deps_lvl1.gpkg")
if (!file.exists(gpkg)) {
peru_lvl1 <- geodata::gadm("PER", level = 1, path = here("data"))
deps <- sf::st_as_sf(peru_lvl1)
sf::st_write(deps, gpkg, delete_dsn = TRUE)
}
deps <- sf::st_read(gpkg, quiet = TRUE)
deps_view <- sf::st_simplify(deps, dTolerance = 0.03, preserveTopology = TRUE)
deps_wgs <- sf::st_transform(deps_view, 4326)
set.seed(1)
deps_wgs$montoviable <- runif(nrow(deps_wgs), 10, 100)
pal <- colorNumeric(palette = "viridis", domain = deps_wgs$montoviable)
leaflet(deps_wgs) |>
addProviderTiles("CartoDB.Positron") |>
addPolygons(
fillColor = ~pal(montoviable),
color = "#444444", weight = 1, opacity = 1,
fillOpacity = 0.7,
label = ~NAME_1,
popup = ~paste0(
"<b>Departamento:</b> ", NAME_1, "<br>",
"<b>Monto viable (M):</b> ", round(montoviable, 1)
)
) |>
addLegend("bottomright", pal = pal, values = ~montoviable,
title = "Monto viable (M)")
View(deps)
#| label: mapa-interactivo
#| echo: false
#| warning: false
#| message: false
library(here)
library(sf)
library(geodata)
library(leaflet)
dir.create(here("data"), showWarnings = FALSE)
gpkg <- here("data", "peru_deps_lvl1.gpkg")
if (!file.exists(gpkg)) {
peru_lvl1 <- geodata::gadm("PER", level = 1, path = here("data"))
deps <- sf::st_as_sf(peru_lvl1)
sf::st_write(deps, gpkg, delete_dsn = TRUE)
}
deps <- sf::st_read(gpkg, quiet = TRUE)
deps_view <- sf::st_simplify(deps, dTolerance = 0.03, preserveTopology = TRUE)
deps_wgs <- sf::st_transform(deps_view, 4326)
set.seed(1)
deps_wgs$montoviable <- runif(nrow(deps_wgs), 10, 100)
pal <- colorNumeric(palette = "viridis", domain = deps_wgs$montoviable)
leaflet(deps_wgs) |>
addProviderTiles("CartoDB.Positron") |>
addPolygons(
fillColor = ~pal(montoviable),
color = "#444444", weight = 1, opacity = 1,
fillOpacity = 0.7,
label = ~NAME_1,
popup = ~paste0(
"<b>Departamento:</b> ", NAME_1, "<br>",
"<b>Monto viable (M):</b> ", round(montoviable, 1)
)
) |>
addLegend("bottomright", pal = pal, values = ~montoviable,
title = "Monto viable (M)")
